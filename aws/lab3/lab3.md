ラボ 3: Amazon EC2 の概要
ラボの概要と目標
アーキテクチャ図

 

このラボでは、Amazon EC2 インスタンスの起動、サイズ変更、管理、モニタリングの概要を説明します。

Amazon Elastic Compute Cloud (Amazon EC2) は、クラウド内で規模を変更できるコンピューティング性能を提供するウェブサービスです。 Amazon EC2 を使用すると、デベロッパーはウェブスケールのクラウドコンピューティングを簡単に利用できるようになります。

Amazon EC2 のシンプルなウェブサービスインターフェイスを使うと、必要な容量の取得、設定が簡単です。 使用するコンピューティングリソースは、お客様自身が完全にコントロールでき、Amazon の実績あるコンピューティング環境で実行できます。 Amazon EC2 では、新しいサーバーインスタンスの取得と起動に要する時間が分単位にまで短縮されるため、容量のスケールアップもダウンも、コンピューティング要件の変化に合わせてすばやく実行できます。

また、Amazon EC2 はコンピューティングの経済性をも変革します。お支払いいただく料金は、実際に使用した容量の分のみです。 デベロッパーは、Amazon EC2 のツールを利用して、耐障害性に優れたアプリケーションを構築し、一般的な障害シナリオの影響を回避することができます。

 

このラボを修了すると、次のことができるようになります。

終了保護を有効にしてウェブサーバーを起動する。
EC2 インスタンスをモニタリングする。
ウェブサーバーで使用するセキュリティグループを変更し、HTTP アクセスを許可する。
Amazon EC2 インスタンスのサイズを変更してスケールし、停止保護を有効にする。
EC2 の制限について調べる。
停止保護をテストする。
EC2 インスタンスを停止する。
 

所要時間
このラボの所要時間は約 35 分です。

 

AWS のサービスの制限事項
このラボ環境では、AWS のサービスとサービスアクションへのアクセスが、ラボの手順を完了するために必要なものに制限される場合があります。 その他のサービスにアクセスしたり、このラボで説明されている以外のアクションを実行しようとしたりすると、エラーが発生することがあります。

 

AWS マネジメントコンソールにアクセスする
この手順の一番上にある  Start Lab をクリックします。

ラボのセッションが開始されます。

ページの一番上にタイマーが表示され、セッションの残り時間がわかります。

 ヒント: タイマーが 00:00 になる前に  Start Lab を再度クリックすることで、セッションの長さをいつでも更新できます。

次に進む前に、左上隅の AWS  リンクの右にある丸いアイコンが緑色になるまで待ちます。 

 

AWS マネジメントコンソールに接続するには、左上隅の [AWS] リンクをクリックします。

新しいブラウザタブが開き、コンソールに接続します。

 ヒント:  新しいブラウザタブが開かない場合、通常、ブラウザがサイトのポップアップウィンドウが開くのをブロックしたというメッセージが付いたバナーまたはアイコンがブラウザの上部に表示されます。 バナーまたはアイコンをクリックし、[Allow pop-ups] をクリックします。

 

[AWS マネジメントコンソール] タブを、この手順の横に並べて表示します。 できれば、ラボのステップを簡単に実行できるように、両方のブラウザタブを同時に表示することをお勧めします。

 

作業内容に対してクレジットを受け取る
このラボの最後には、ラボの作業内容を送信し、進捗状況に応じたスコアを受け取るようにという指示があります。

 ヒント: 作業をチェックするスクリプトでは、指定されたとおりにリソースに名前を付け、設定が行われていないと、ポイントが付与されない場合があります。 特に、ラボの手順に This Format という形式で表示されている値については、記載されているとおりに入力してください (大文字と小文字は区別されます)。

 

タスク 1: Amazon EC2 インスタンスを起動する
このタスクでは、終了保護と停止保護を有効にした Amazon EC2 インスタンスを起動します。 終了保護は EC2 インスタンスが誤って終了されるのを防ぎ、停止保護は EC2 インスタンスが誤って停止されるのを防ぎます。 また、単純なウェブサーバーをデプロイするインスタンスの起動時に、ユーザーデータスクリプトを指定します。

 

AWS マネジメントコンソールで  Services、[Compute]、[EC2] の順にクリックします。

注意: EC2 コンソールが現在 [N. Virginia] (us-east-1) リージョンのリソースを管理していることを確認します。 これは、画面上部に表示されたユーザー名の左側にあるドロップダウンメニューで確認できます。 [N. Virginia] と表示されていない場合は、次のステップに進む前に、リージョンメニューから [N. Virginia] リージョンを選択します。

 

Launch instance メニューをクリックして、[Launch instance] を選択します。

 

ステップ 1: 名前とタグ
インスタンスに Web Server という名前を付けます。

 このインスタンスに付けた名前は、タグとして保存されます。 タグを使用すると、目的別、所有者別、環境別など、さまざまな方法で AWS リソースを分類できます。 これは、同じタイプのリソースが多数ある場合に便利です。割り当てたタグに基づいて、特定のリソースをすぐに識別できるためです。 それぞれのタグは、ユーザーが定義するキーと値で構成されます。 必要に応じて、インスタンスには複数のタグを定義して関連付けることができます。

今回作成されるタグは、Web Server という値を持つ Name というキーで構成されます。

 

ステップ 2: アプリケーションと OS のイメージ (Amazon マシンイメージ)
利用できる Quick Start AMI リストで、デフォルトの [Amazon Linux] AMI が選択されたままにします。 

 

デフォルトの [Amazon Linux 2023 AMI] も選択されたままにします。

 Amazon マシンイメージ (AMI) は、クラウドの仮想サーバーであるインスタンスの起動に必要な情報を提供します。 AMI には次が含まれます。

インスタンスのルートボリュームのテンプレート (オペレーティングシステム、アプリケーションを含むアプリケーションサーバーなど)
どの AWS アカウントが AMI を使用してインスタンスを起動できるかを管理する起動許可
インスタンスの起動時にインスタンスに添付するボリュームを指定するブロックデバイスマッピング
Quick Start リストには、最もよく使用される AMI が表示されています。 独自の AMI を作成することも、AWS Marketplace で AMI を選択することもできます。Marketplace とは、AWS で実行できるソフトウェアを売買するためのオンラインストアです。

 

ステップ 3: インスタンスタイプ
[Instance type] パネルでは、デフォルトの t2.micro を選択したままにします。

 Amazon EC2 では、さまざまなユースケースに合わせて最適化された幅広い種類のインスタンスタイプが提供されています。 インスタンスタイプは CPU、メモリ、ストレージ、ネットワーク容量のさまざまな組み合わせで構成されており、アプリケーションに応じて適切なリソースの組み合わせを柔軟に選択できます。 各インスタンスタイプには 1 つ以上のインスタンスサイズがあり、対象のワークロードの要件に応じてリソースをスケールできます。

t2.micro インスタンスタイプは、1 基の仮想 CPU と 1 ギビバイト (GiB) のメモリを備えています。 

注意: このラボでは、他のインスタンスタイプの使用が制限されている場合があります。

 

ステップ 4: キーペア (ログイン)
[Key pair name - required] には、[vockey] を選択します。 

 Amazon EC2 ではパブリックキー暗号化を使用して、ログイン情報の暗号化と復号を行います。 作成したインスタンスのゲスト OS に確実にログインできるようにするには、インスタンスの起動時に既存のキーペアを特定するか、新しいキーペアを作成します。 Amazon EC2 はその後、インスタンスの起動時にそのキーをゲスト OS にインストールします。  こうすることにより、インスタンスへのログインに秘密キーを入力することで、インスタンスへの接続が許可されます。

注意: このラボでは、インスタンスにログインするために指定したキーペアは実際には使用しません。

 

ステップ 5: ネットワークの設定
[Network settings] の横にある [Edit] をクリックします。

 

[VPC] には [Lab VPC] を選択します。

Lab VPC は、ラボの設定プロセス中に AWS CloudFormation テンプレートを使用して作成されています。 この VPC には、2 つの異なるアベイラビリティーゾーンにパブリックサブネットが 2 つ設定されています。

 注意: デフォルトのサブネット PublicSubnet1 はそのままにしておきます。 このサブネットでこのインスタンスを実行します。 なお、このインスタンスには、デフォルトでパブリック IP アドレスが割り当てられます。

 

[Firewall (security groups)] で  Create security group をクリックして、次の設定を行います。

Security group name: Web Server security group

Description: Security group for my web server

 セキュリティグループは、単一または複数のインスタンスのトラフィックを管理する仮想ファイアウォールとして機能します。 インスタンスの起動時に、1 つ以上のセキュリティグループをインスタンスに関連付けます。 各セキュリティグループに、関連付けられたインスタンスとの間のトラフィックを許可するルールを追加します。 セキュリティグループのルールは随時変更できます。新しいルールは、セキュリティグループに関連付けられているインスタンスすべてに自動的に適用されます。

[Inbound security group rules] にルールが 1 つあります。 このルールは削除します。

 

ステップ 6: ストレージの設定
[Configure storage] セクションについては、デフォルト設定のままにします。

 Amazon EC2 は、Elastic Block Store と呼ばれるネットワーク接続された仮想ディスクにデータを保存します。

このラボでは、デフォルトの 8 ギビバイト (GiB) のディスクボリュームを使用して Amazon EC2 インスタンスを起動します。 これがルートボリューム (「ブート」ボリュームとも呼ばれる) になります。

 

ステップ 7: 高度な詳細
 Advanced details を展開します。

 

[Termination protection] で [Enable] を選択します。

 不要になった Amazon EC2 インスタンスは、終了できます。終了したインスタンスは削除され、そのインスタンスのリソースは解放されます。 終了したインスタンスには再度アクセスすることはできず、インスタンス上のデータも復元できません。 インスタンスが意図せず終了されるのを防止するには、インスタンスの終了保護を有効化します。終了保護が有効である間は、インスタンスは終了されることはありません。

 

ページの一番下までスクロールし、下に表示されているコードをコピーして [User data] ボックスに貼り付けます。

#!/bin/bash
dnf install -y httpd
systemctl enable httpd
systemctl start httpd
echo '<html><h1>Hello From Your Web Server!</h1></html>' > /var/www/html/index.html
 インスタンス起動時にユーザーデータをインスタンスに渡して、そのデータでインスタンス起動後の自動的なインストールとタスク設定を実行することができます。

このインスタンスは Amazon Linux 2023 を実行しており、指定したシェルスクリプトは、インスタンス起動時に root のゲスト OS ユーザーとして実行されます。 このスクリプトが実行する内容は次のとおりです。

Apache ウェブサーバー (httpd) をインストールする。
起動時に自動的に開始するようにウェブサーバーを設定する。
インストール完了後にウェブサーバーを実行する。
シンプルなウェブページを作成する。
 

ステップ 8: インスタンスの起動
[Summary] パネルの下部で Launch instance をクリックします。

「Success」というメッセージが表示されます。

 

View all instances をクリックします。

インスタンスリストで  Web Server を選択します。 

[Details] タブに表示された情報を確認します。 このタブには、インスタンスタイプ、セキュリティ設定、ネットワーク設定についての情報が表示されています。

インスタンスには、インターネットからこのインスタンスにアクセスするために使用できる Public IPv4 DNS が割り当てられています。

 詳細を確認するには、ウィンドウの仕切りを上にドラッグしてください。

インスタンスのステータスには最初、「Pending」と表示されます。これは、起動中であることを示します。 次にステータスは「Initializing」に変わり、最終的には「Running」となります。

 

インスタンスに次が表示されるまで待ちます。

Instance State:  Running
Status Checks:   2/2 checks passed
 

 お疲れ様でした。 初めての Amazon EC2 インスタンスの起動が正常に完了しました。

 

タスク 2: インスタンスをモニタリングする
モニタリングは、Amazon Elastic Compute Cloud (Amazon EC2) インスタンスと AWS ソリューションの信頼性、可用性、パフォーマンスを維持するうえで重要です。

 

[Status checks] タブをクリックします。

 インスタンスのステータスをモニタリングすると、インスタンスのアプリケーションの実行を妨げる何らかの問題が Amazon EC2 で検出されているかどうかを迅速に判断できます。 Amazon EC2 は、実行中のすべての EC2 インスタンスに対して自動チェックを実行し、ハードウェアとソフトウェアの問題を特定します。

System reachability と Instance reachability の両方のチェックが合格していることを確認します。

 

[Monitoring] タブをクリックします。

このタブには、インスタンスの Amazon CloudWatch メトリクスが表示されます。 現時点では、インスタンスが起動されたばかりであるため、表示されるメトリクスは多くありません。

任意のグラフの 3 点アイコンをクリックして、[Enlarge] を選択すると、選択したメトリクスを拡張表示できます。

 Amazon EC2 は、EC2 インスタンスのメトリクスを Amazon CloudWatch に送信します。 デフォルトでは、基本モニタリング (5 分) が有効になっています。 詳細モニタリング (1 分) を有効にすることもできます。

 

コンソールの上部にある Actions  メニューで [Monitor and troubleshoot]  [Get system log] の順に選択します。

システムログにインスタンスのコンソール出力が表示されます。これは問題の診断に役立ちます。 SSH Daemon が起動されるまでにインスタンスが終了したり到達不能になったりする可能性のある、カーネルの問題やサービス設定の問題のトラブルシューティングには、特に役に立ちます。 システムログが表示されない場合は、数分待ってからもう一度試してください。

 

出力の内容を下にスクロールしていくと、インスタンス作成時に追加したユーザーデータから HTTP パッケージがインストールされていることが確認できます。

コンソールの出力

[Cancel] をクリックします。

 

[Web Server] が選択されたままであることを確認します。 次に、Actions  メニューで [Monitor and troubleshoot]  [Get instance screenshot] の順に選択します。

これにより、Amazon EC2 インスタンスコンソールに画面が接続された際にどのような表示になるかを確認できます。

スクリーンショット

 

 SSH や RDP を介してインスタンスにアクセスできない場合、インスタンスのスクリーンショットをキャプチャして、画像で確認できます。 このようにインスタンスのステータスを可視化すると、迅速にトラブルシューティングを行うことができます。

 

[Cancel] をクリックします。

 お疲れ様でした。 インスタンスのモニタリング方法をいくつか確認できました。

 

タスク 3: セキュリティグループを更新してウェブサーバーにアクセスする
EC2 インスタンスを起動したときに、スクリプトによってウェブサーバーのインストールとシンプルなウェブページの作成を行いました。 このタスクでは、このウェブサーバーのコンテンツにアクセスします。

 

[Web Server] が選択されたままであることを確認します。  [Details] タブをクリックします。

 

インスタンスのパブリック IPv4 アドレスをクリップボードにコピーします。

 

ウェブブラウザで新しいタブを開き、コピーした IP アドレスを貼り付けて Enter キーを押します。

質問: ウェブサーバーにアクセスできましたか。 できなかったのはなぜでしょうか。

現在ウェブサーバーにアクセスできないのは、HTTP ウェブリクエストに使用されるポート 80 で、インバウンドトラフィックがセキュリティグループによって許可されていないためです。 これはセキュリティグループをファイアウォールとして使用し、インスタンスに出入りするネットワークトラフィックを制限する実例です。

これを修正するには、ポート 80 でウェブトラフィックを許可するようセキュリティグループを更新します。

 

ブラウザの現在のタブは開いたままにして、[EC2 Console] タブに戻ります。

 

左側のナビゲーションペインで [Security Groups] をクリックします。

 

 Web Server security group を選択します。

 

[Inbound rules] タブをクリックします。

現在、このセキュリティグループにはインバウンドルールがありません。

 

Edit inbound rules、Add rule の順にクリックして、次の設定を行います。

Type: HTTP

Source: Anywhere-IPv4

Save rules をクリックする

 

先ほど開いたウェブサーバーのタブに戻り、ページを更新  します。

「Hello From Your Web Server!」というメッセージが表示されます。

 

 お疲れ様でした。 Amazon EC2 インスタンスへの HTTP トラフィックを許可するようにセキュリティグループを変更することができました。

 

タスク 4: インスタンスのサイズを変更する: インスタンスタイプと EBS ボリューム
ニーズが変化するにつれて、インスタンスの使用率が高すぎる (インスタンスタイプが小さすぎる) ことや低すぎる (インスタンスタイプが大きすぎる) ことに気付く場合があります。 この場合は、インスタンスタイプを変更できます。 例えば、t2.micro インスタンスがワークロードに対して小さすぎる場合、m5.medium インスタンスに変更できます。 同様に、ディスクのサイズも変更できます。

 

インスタンスを停止する
インスタンスは、サイズを変更する前に停止する必要があります。

 インスタンスを停止すると、インスタンスはシャットダウンされます。 停止した EC2 インスタンスに対してはランタイム料金は発生しませんが、アタッチした Amazon EBS ボリュームには引き続きストレージ料金が発生します。

[EC2 マネジメントコンソール] の左側のナビゲーションペインで [Instances] をクリックし、 Web Server インスタンスを選択します。

 

Instance State  メニューで [Stop instance] を選択します。

 

Stop をクリックします。

インスタンスは、通常のシャットダウンを実行した後、停止します。

 

[Instance state] の表示が  Stopped になるまで待ちます。

 

インスタンスタイプを変更して停止保護を有効にする
ウェブサーバーのインスタンスを選択し、Actions  メニューをクリックして、[Instance settings]  [Change instance type] の順に選択し、次のように設定します。

Instance Type: t2.small

Apply をクリックする

再起動すると、インスタンスは t2.small として実行します。このインスタンスには、メモリが t2.micro インスタンスの 2 倍あります。 注意: このラボでは、他のインスタンスタイプの使用が制限されている場合があります。

 

ウェブサーバーのインスタンスを選択し、Actions  メニューをクリックして、[Instance settings]  [Change stop protection] の順に選択します。 [Enable] をオンにして、変更を [Save] します。

 インスタンスを停止すると、インスタンスはシャットダウンします。 後でインスタンスを起動すると、通常、新しい基盤ホストコンピュータに移行され、新しいパブリック IPv4 アドレスが割り当てられます。 インスタンスに割り当てられたプライベート IPv4 アドレスは保持されます。 インスタンスを停止しても、インスタンスは削除されません。 EBS ボリュームとそのボリューム上のデータはすべて保持されます。 

 

EBS ボリュームのサイズを変更する
ウェブサーバーのインスタンスを選択したままで、[Storage] タブをクリックし、ボリューム ID 名を選択してから、表示されているボリュームの横にあるチェックボックスをオンにします。

 

Actions  メニューで [Modify volume] を選択します。

現在のディスクボリュームのサイズは 8 ギビバイト (GiB) です。 このディスクサイズを増やします。

 

サイズを 10 に変更します。注意: このラボでは、作成する Amazon EBS ボリュームのサイズが 10 GB 未満に制限される場合があります。

 

Modify をクリックします。

 

もう一度 Modify をクリックして確定し、ボリュームのサイズを増やします。

 

サイズを変更したインスタンスを起動する
次に、インスタンスを再起動します。インスタンスのメモリとディスク容量が増加しています。

左側のナビゲーションペインで [Instances] をクリックします。

 

[Web Server] インスタンスを選択します。

 

Instance state  メニューで [Start instance] を選択します。

 お疲れ様でした。 Amazon EC2 インスタンスのサイズ変更が完了しました。 このタスクでは、インスタンスタイプを t2.micro から t2.small に変更しました。 また、ルートディスクボリュームも 8 ギビバイト (GiB) から 10 ギビバイト (GiB) に変更しました。

 

タスク 5: EC2 の制限について調べる
Amazon EC2 には、利用可能なさまざまなリソースが用意されています。 利用できるリソースには、イメージ、インスタンス、ボリューム、スナップショットなどがあります。 AWS アカウントを作成すると、これらのリソースに対して、各リージョンに基づくデフォルトの制限が適用されます。

 

AWS マネジメントコンソールの  Services の横にある検索ボックスで Service Quotas を検索して、選択します。

 

ナビゲーションメニューで [AWS services] をクリックして、AWS サービスの [Find services] 検索バーで ec2 を検索し、[Amazon Elastic Compute Cloud (Amazon EC2)] をクリックします。

 

[Find quotas] 検索バーで running on-demand を検索します。ただし、選択はしません。 その代わりに、条件に一致する Service Quotas のフィルターが適用されたリストを調べます。

リージョン内で実行できるインスタンスの数とタイプには制限があることに注意してください。 例えば、このリージョンで起動できる Running On-Demand Standard... インスタンスの数には制限があります。 インスタンスの起動リクエストによって、使用量がそのリージョンで現在定義されているインスタンス制限を超える場合、インスタンスを起動することはできません。

これらの制限は多くの場合、AWS アカウントで引き上げをリクエストできます。

 

タスク 6: 停止保護をテストする
インスタンスにアクセスする必要はないが、保持したい場合は、インスタンスを停止することができます。 このタスクでは、終了保護の使用方法を学習します。

 

AWS マネジメントコンソールの  Services の横にある検索ボックスで EC2 を検索してクリックし、EC2 コンソールに戻ります。

 

左側のナビゲーションペインで [Instances] をクリックします。

 

[Web Server] インスタンスを選択して、Instance state  メニューで [Stop instance] を選択します。

 

次に、Stop をクリックします。

次のメッセージが表示されることを確認します。「Failed to stop the instance i-1234567xxx. The instance 'i-1234567xxx' may not be stopped. Modify its 'disableApiStop' instance attribute and try again.」

これは、このラボで以前に有効にした停止保護が、インスタンスの偶発的な停止を防止する保護機能を提供していることを示しています。 インスタンスを本当に終了する場合は、停止保護を無効にする必要があります。

 

Actions  メニューで [Instance settings]  Change stop protection の順に選択します。

 

 Enable の横にあるチェックボックスをオフにします。

 

保存 をクリックします。

これでインスタンスを停止できるようになりました。

 

[Web Server] インスタンスをもう一度選択して、Instance state  メニューで [Stop instance] を選択します。

 

Stop をクリックします。

 お疲れ様でした。 停止保護機能をテストし、インスタンスを停止することができました。

 

作業内容を送信する
進行状況を記録するには、この手順の一番上にある [Submit] をクリックします。

 

プロンプトが表示されたら [Yes] をクリックします。

数分後、成績パネルが表示され、各タスクで何点獲得したかを確認できます。 数分経っても結果が表示されない場合は、この手順の一番上に戻り、[Grades] をクリックします。

 重要: このラボの提出プロセスで行われるチェックの中には、アクションを完了してから少なくとも 5 分経過していないとクレジットが与えられないものがあります。 初回送信時にクレジットが加算されなかった場合は、数分待ってから再度送信してください。

 ヒント: 作業内容は複数回送信できます。 作業内容を変更したら、もう一度 [Submit] をクリックします。 最後に送信したものがこのラボの記録として残ります。

 

作業内容に関する詳細なフィードバックを確認するには、[Submission Report] をクリックします。

 ヒント: 満点を獲得できなかったチェックについては、役立つ情報が提出レポートに記載されていることがあります。

 

ラボの完了
お疲れ様でした。 これでこのラボは終了です。

このページの上部にある End Lab をクリックし、Yes をクリックしてラボを終了することを確認します。  

[End Lab] パネルが開き、「You may close this message box now.」というメッセージが表示されます。

 

このパネルを閉じるには、右上隅の [X] をクリックします。

 

その他のリソース
インスタンスの起動
Amazon EC2 インスタンスタイプ
Amazon マシンイメージ (AMI)
Amazon EC2 - ユーザーデータとシェルスクリプト
Amazon EC2 インスタンスのルートデバイスボリューム
Amazon EC2 リソースのタグ付け
セキュリティグループ
Amazon EC2 のキーペア
インスタンスのステータスチェック
コンソール出力の取得とインスタンスの再起動
Amazon EC2 メトリクスとディメンション
インスタンスのサイズ変更
インスタンスの停止と起動
Amazon EC2 サービスの制限
インスタンスの終了
インスタンスの終了保護の有効化
 

© 2023, Amazon Web Services, Inc. and its affiliates. All rights reserved. このトレーニング内容の全体または一部を複製または再配布することは、Amazon Web Services, Inc. の書面による事前の許可がある場合を除き、禁じられています。商業目的のコピー、貸与、または販売を禁止します。
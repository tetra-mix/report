ラボ 2: VPC を構築し、ウェブサーバーを起動する
ラボの概要と目標
このラボでは、Amazon Virtual Private Cloud (VPC) を使用して独自の VPC を作成し、コンポーネントを追加して、カスタマイズしたネットワークを作成します。 セキュリティグループも作成します。 次に、ウェブサーバーを実行する EC2 インスタンスの設定とカスタマイズを行い、この EC2 インスタンスを起動して、VPC のサブネットで実行します。

Amazon Virtual Private Cloud (Amazon VPC) を使用すると、ユーザー定義の仮想ネットワーク内で Amazon Web Services (AWS) のリソースを起動できます。 この仮想ネットワークは、独自のデータセンターで運用しているような従来のネットワークによく似ていますが、AWS のスケーラブルなインフラストラクチャを使用できるという利点があります。 複数のアベイラビリティーゾーンにまたがる VPC を作成できます。

このラボを修了すると、次のことができるようになります。

VPC を作成する。

サブネットを作成する。

セキュリティグループを設定する。

VPC 内で EC2 インスタンスを起動する。

 

所要時間
このラボの所要時間は約 30 分です。

 

AWS のサービスの制限事項
このラボ環境では、AWS のサービスとサービスアクションへのアクセスが、ラボの手順を完了するために必要なものに制限される場合があります。 その他のサービスにアクセスしたり、このラボで説明されている以外のアクションを実行しようとしたりすると、エラーが発生することがあります。

 

シナリオ
このラボでは、次のとおりのインフラストラクチャを構築します。

アーキテクチャ

AWS マネジメントコンソールにアクセスする
この手順の一番上にある  Start Lab をクリックします。

ラボのセッションが開始されます。

ページの一番上にタイマーが表示され、セッションの残り時間がわかります。

 ヒント: タイマーが 00:00 になる前に  Start Lab を再度クリックすることで、セッションの長さをいつでも更新できます。

次に進む前に、左上隅の AWS  リンクの右にある丸いアイコンが緑色になるまで待ちます。 

 

AWS マネジメントコンソールに接続するには、左上隅の [AWS] リンクをクリックします。

新しいブラウザタブが開き、コンソールに接続します。

 ヒント:  新しいブラウザタブが開かない場合、通常、ブラウザがサイトのポップアップウィンドウが開くのをブロックしたというメッセージが付いたバナーまたはアイコンがブラウザの上部に表示されます。 バナーまたはアイコンをクリックし、[Allow pop-ups] をクリックします。

 

[AWS マネジメントコンソール] タブを、この手順の横に並べて表示します。 できれば、ラボのステップを簡単に実行できるように、両方のブラウザタブを同時に表示することをお勧めします。

 

作業内容に対してクレジットを受け取る
このラボの最後には、ラボの作業内容を送信し、進捗状況に応じたスコアを受け取るようにという指示があります。

 ヒント: 作業をチェックするスクリプトでは、指定されたとおりにリソースに名前を付け、設定が行われていないと、ポイントが付与されない場合があります。 特に、ラボの手順に This Format という形式で表示されている値については、記載されているとおりに入力してください (大文字と小文字は区別されます)。

 

タスク 1: VPC を作成する
このタスクでは、VPC コンソールで [VPC and more] オプションを使用して、VPC、インターネットゲートウェイ、パブリックサブネット、単一のアベイラビリティーゾーン内のプライベートサブネット、2 つのルートテーブル、NAT ゲートウェイなど複数のリソースを作成します。

 

 Services の右側にある検索ボックスで VPC を検索してクリックし、VPC コンソールを開きます。

   

VPC の作成を開始します。

画面の右上で、現在のリージョンが [N. Virginia (us-east-1)] であることを確認する。 

コンソールの左上部の方にある [VPC dashboard] のリンクをクリックする。

次に、Create VPC をクリックする。 

注意: この名前のボタンが表示されていない場合は、[Launch VPC Wizard] ボタンをクリックします。

  

左側の [VPC settings] パネルで VPC の詳細を次のとおりに設定します。

[VPC and more] をクリックする。

[Name tag auto-generation] の [Auto-generate] の選択はオンにしたままで、値を project から lab に変更する。

[IPv4 CIDR block] の設定は、10.0.0.0/16 のままにする。

[Number of Availability Zones] には、1 を選択する。

[Number of public subnets] の設定は、1 のままにする。

[Number of private subnets] の設定は、1 のままにする。

[Customize subnets CIDR blocks] セクションを展開する。

[Public subnet CIDR block in us-east-1a] を 10.0.0.0/24 に変更する。
[Private subnet CIDR block in us-east-1a] を 10.0.1.0/24 に変更する。
[NAT gateways] を In 1 AZ に設定する。

[VPC endpoints] を None に設定する。

[DNS hostnames] と [DNS resolution] はどちらも enabled のままにする。

 

右側の [Preview] パネルで、設定した内容を確認します。

VPC: lab-vpc

Subnets:

us-east-1a

Public subnet name: lab-subnet-public1-us-east-1a
Private subnet name: lab-subnet-private1-us-east-1a
Route tables

lab-rtb-public
lab-rtb-private1-us-east-1a
Network connections

lab-igw
lab-nat-public1-us-east-1a 
 

画面の下部にある Create VPC をクリックします。

VPC リソースが作成されました。 NAT ゲートウェイのアクティベーションには数分かかります。 

すべてのリソースの作成が完了するまで待ってから、次のステップに進みます。

 

作成が完了したら、View VPC をクリックします。

このウィザードは、単一のアベイラビリティーゾーンに、パブリックサブネット、プライベートサブネット、各サブネットのルートテーブルがある VPC をプロビジョンしました。 インターネットゲートウェイと NAT ゲートウェイも作成しています。 

これらのリソースの設定を確認するには、リソースの詳細に表示されている VPC コンソールリンクを使用して調べます。 例えば、[Subnets] をクリックするとサブネットの詳細を、[Route tables] をクリックするとルートテーブルの詳細を確認できます。 下の図は、作成した VPC リソースとその設定をまとめたものです。

タスク 1

 

インターネットゲートウェイとは、VPC 内の EC2 インスタンスとインターネット間の通信を許可する VPC リソースです。 

lab-subnet-public1-us-east-1a のパブリックサブネットの CIDR は 10.0.0.0/24 です。これは、10.0.0.x で始まるすべての IP アドレスが含まれていることを意味します。 このパブリックサブネットに関連付けられたこのルートテーブルは、0.0.0.0/0 のネットワークトラフィックをインターネットゲートウェイに送信するという事実により、パブリックサブネットとなります。

NAT ゲートウェイとは、VPC 内のプライベートサブネットで実行しているすべての EC2 インスタンスにインターネット接続を提供するために使用される VPC リソースです。これにより、EC2 インスタンスは、インターネットゲートウェイに直接接続する必要はありません。

lab-subnet-private1-us-east-1a のプライベートサブネットの CIDR は 10.0.1.0/24 です。これは、10.0.1.x で始まるすべての IP アドレスを含んでいることを意味します。

 

タスク 2: 追加のサブネットを作成する
このタスクでは、2 番目のアベイラビリティーゾーンで、VPC のためにさらに 2 つのサブネットを作成します。 VPC 内の複数のアベイラビリティーゾーンにサブネットがあると、高可用性を提供するソリューションのデプロイに役立ちます。 

このように VPC を作成した後でも、さらにサブネットを追加するなど、設定を追加することができます。 作成するサブネットはすべて完全に単一のアベイラビリティーゾーン内に配置されます。 

 

左側のナビゲーションペインで [Subnets] をクリックします。

まず、2 番目のパブリックサブネットを作成します。

 

Create subnet をクリックして、次のとおりに設定します。

VPC ID: lab-vpc (メニューから選択)
Subnet name: lab-subnet-public2
Availability Zone: 2 番目のアベイラビリティーゾーン (us-east-1b など) を選択します。
IPv4 CIDR block: 10.0.2.0/24
このサブネットには、10.0.2.x で始まるすべての IP アドレスが含まれます。

 

Create subnet をクリックします

2 つ目のパブリックサブネットが作成されました。 次に、2 番目のプライベートサブネットを作成します。

 

Create subnet をクリックして、次のとおりに設定します。

VPC ID: lab-vpc
Subnet name: lab-subnet-private2
Availability Zone: 2 番目のアベイラビリティーゾーン (us-east-1b など) を選択します。
IPv4 CIDR block: 10.0.3.0/24
このサブネットには、10.0.3.x で始まるすべての IP アドレスが含まれます。

 

Create subnet をクリックします

2 つ目のプライベートサブネットが作成されました。 

次に、インターネットに送信されるトラフィックを NAT ゲートウェイに送信するように、この新しいプライベートサブネットを設定します。これにより、2 番目のプライベートサブネットのリソースはプライベートのままでインターネットに接続できるようになります。 これを実行するには、ルートテーブルを設定します。

ルートテーブルには、ルートと呼ばれるルールセットが含まれています。ルートによって、ネットワークトラフィックの送信先が決まります。 サブネットのルーティングは、ルートテーブルが管理するため、VPC のすべてのサブネットはルートテーブルに関連付けられている必要があります。

 

左側のナビゲーションペインで [Route tables] を選択します。

 

 lab-rtb-private1-us-east-1a ルートテーブルを選択します。

 

下のペインで [Routes] タブをクリックします。

Destination 0.0.0.0/0 が Target nat-xxxxxxxx に設定されていることを確認します。 これは、インターネット (0.0.0.0/0) 宛てのトラフィックが NAT ゲートウェイに送信されることを意味します。 その後トラフィックは、NAT ゲートウェイによってインターネットに転送されます。

つまり、このルートテーブルはプライベートサブネットからのトラフィックの送信のために使用されます。 

 

[Subnet associations] タブをクリックします。

タスク 1 で VPC とその VPC 内に複数のリソースを作成した時に、このルートテーブルが作成されています。 そのアクションによって lab-subnet-private-1 も作成され、このルートテーブルに関連付けられています。 

もう 1 つのプライベートサブネットである lab-subnet-private-2 を作成したところで、このサブネットもこのルートテーブルに関連付けます。

 

[Explicit subnet associations] パネルで、Edit subnet associations をクリックします。

 

[lab-subnet-private1-us-east-1a] は選択したままにして、 lab-subnet-private2 も選択します。

 

Save associations をクリックします。

次に、パブリックサブネットが使用するルートテーブルを設定します。

 

 lab-rtb-public ルートテーブルを選択します (その他のサブネットの選択はオフにします)。

 

下のペインで [Routes] タブをクリックします。

Destination 0.0.0.0/0 が、インターネットゲートウェイであるターゲットの igw-xxxxxxxx に設定されていることを確認します。 これは、インターネット宛てのトラフィックは、インターネットゲートウェイ経由で直接インターネットに送信されることを意味します。

次に、このルートテーブルを 2 番目のパブリックサブネットに関連付けます。

 

[Subnet associations] タブをクリックします。

 

[Explicit subnet associations] エリアで、Edit subnet associations をクリックします。

 

[lab-subnet-public1-us-east-1a] は選択したままにして、 lab-subnet-public2 も選択します。

 

Save associations をクリックします。

これで、2 つのアベイラビリティーゾーンにパブリックサブネットとプライベートサブネットが設定された VPC ができました。 タスク 1 で作成したルートテーブルも、この 2 つの新しいサブネットにネットワークトラフィックを送信するように更新されています。

タスク 2

 

タスク 3: VPC セキュリティグループを作成する
このタスクでは、仮想ファイアウォールとして機能する VPC セキュリティグループを作成します。 インスタンスの起動時に、1 つ以上のセキュリティグループをインスタンスに関連付けます。 各セキュリティグループにルールを追加すると、関連付けられたインスタンスの双方向のトラフィックを許可できます。

 

左側のナビゲーションペインで [Security groups] をクリックします。

 

Create security group をクリックして、次のとおりに設定します。

Security group name: Web Security Group

Description: Enable HTTP access

VPC: 現在選択されている VPC を [X] をクリックして削除し、ドロップダウンリストから [lab-vpc] を選択します。

 

[Inbound rules] ペインで、Add rule をクリックします。

 

以下のとおり設定します。

Type: HTTP

Source: Anywhere-IPv4

Description: Permit web requests

 

ページの一番下までスクロールして、Create security group をクリックします。

このセキュリティグループは、次のタスクで Amazon EC2 インスタンスを起動する際に使用します。

 

タスク 4: ウェブサーバーインスタンスを起動する
このタスクでは、Amazon EC2 インスタンスを新しい VPC で起動します。 このインスタンスがウェブサーバーとして機能するように設定します。

 

 Services の右側にある検索ボックスで EC2 を検索してクリックし、EC2 コンソールを開きます。

 

Launch instance メニューから [Launch Instance] を選択します。

 

以下のとおりインスタンスに名前を付けます。

Web Server 1 と名前を付けます。

インスタンスに名前を付けると、AWS はタグを作成して、このタグをインスタンスに関連付けます。 タグとはキーバリューのペアです。 このペアのキーは *Name* で、値はこの EC2 インスタンスに指定した名前です。

 

次のとおりインスタンスを作成する AMI を選択します。

利用できる Quick Start AMI の一覧では、デフォルトの [Amazon Linux] が選択されたままにします。 

デフォルトの [Amazon Linux 2023 AMI] も選択されたままにします。

選択する Amazon マシンイメージ (AMI) タイプに基づいて、起動する EC2 インスタンス上で実行されるオペレーティングシステムが定まります。

 

インスタンスタイプを以下のとおり選択します。

[Instance type] パネルでは、デフォルトの t2.micro を選択したままにします。

[Instance type] は、このインスタンスに割り当てられるハードウェアリソースを定義します。

 

このインスタンスに関連付けるキーペアを以下のとおり選択します。

[Key pair name] メニューから、[vockey] を選択します。

選択した vockey キーペアを使用すると、起動後にこのインスタンスに SSH 経由で接続できます。 このラボでは必要ありませんが、インスタンスを起動する際には、既存のキーペアを指定するか、新しいキーペアを作成するか、キーペアなしで続行することを選ぶ必要があります。

 

ネットワークを次のとおりに設定します。

[Network settings] の横の [Edit] をクリックして、次のとおりに設定します。 

Network: lab-vpc 
Subnet: lab-subnet-public2 (プライベートではないことに注意してください)
Auto-assign public IP: Enable
次に、前半で作成したウェブセキュリティグループを使用するようにこのインスタンスを設定します。

[Firewall (security groups)] で  Select existing security group をクリックします。

[Common security groups] には  Web Security Group を選択します。

このセキュリティグループが、このインスタンスの HTTP アクセスを許可します。

 

[Configure storage] セクションについては、デフォルト設定のままにします。

注意: デフォルト設定では、先ほど指定した Amazon Linux のゲストオペレーティングシステムをホストするインスタンスのルートボリュームが、8 ギビバイト (GiB) のサイズの汎用 SSD (gp3) のハードドライブ上で実行するように指定されています。 ストレージボリュームを追加することもできますが、このラボでは必要ありません。

 

起動時のインスタンスで実行されるスクリプトを以下のとおり設定します。 

[Advanced details] パネルを展開します。

ページの一番下までスクロールし、下に表示されているコードをコピーして [User data] ボックスに貼り付けます。

#!/bin/bash
# Install Apache Web Server and PHP
dnf install -y httpd wget php mariadb105-server
# Download Lab files
wget https://aws-tc-largeobjects.s3.us-west-2.amazonaws.com/CUR-TF-100-ACCLFO-2/2-lab2-vpc/s3/lab-app.zip
unzip lab-app.zip -d /var/www/html/
# Turn on web server
chkconfig httpd on
service httpd start
このスクリプトは、このインスタンスのゲスト OS で、ルートユーザーのアクセス許可で実行されます。 このスクリプトは、インスタンスの初回起動時に自動的に実行されます。 このスクリプトは、このウェブサーバーにウェブサーバー、データベース、PHP ライブラリをインストールし、PHP ウェブアプリケーションをダウンロードしてインストールします。

 

画面の右側にある [Summary] パネルの下部で Launch instance をクリックします。

「Success」というメッセージが表示されます。

 

View all instances をクリックします。

 

[Web Server 1] の [Status check] 列に、「2/2 checks passed」と表示されるまで待ちます。

 このプロセスには数分かかることがあります。 インスタンスの最新のステータスを迅速に把握するには、ページ上部の  アイコンを約 30 秒ごとにクリックします。

次に、EC2 インスタンスで実行しているウェブサーバーに接続します。

 

 Web Server 1 をクリックします。

 

ページの下部の [Details] タブに表示されている [Public IPv4 DNS] の値をコピーします。

 

ウェブブラウザで新しいタブを開き、Public DNS の値を貼り付けて、Enter キーを押します。

AWS ロゴとインスタンスのメタデータの値が記載されたウェブページが表示されるはずです。

デプロイしたアーキテクチャの全体は次のとおりです。

アーキテクチャ

 

作業内容を送信する
進行状況を記録するには、この手順の一番上にある [Submit] をクリックします。

 

プロンプトが表示されたら [Yes] をクリックします。

数分後、成績パネルが表示され、各タスクで何点獲得したかを確認できます。 数分経っても結果が表示されない場合は、この手順の一番上に戻り、[Grades] をクリックします。

 ヒント: 作業内容は複数回送信できます。 作業内容を変更したら、もう一度 [Submit] をクリックします。 最後に送信したものがこのラボの記録として残ります。

 

作業内容に関する詳細なフィードバックを確認するには、[Submission Report] をクリックします。

 ヒント: 満点を獲得できなかったチェックについては、役立つ情報が提出レポートに記載されていることがあります。

 

ラボの完了 
お疲れ様でした。 これでこのラボは終了です。

 

ラボの終了を確定するには、このページの上部にある  End Lab をクリックし、Yes を選択します。

パネルには「You may close this message box now...」と表示されます。

 

右上隅の [X] をクリックしてパネルを閉じます。
 

© 2023, Amazon Web Services, Inc. and its affiliates. All rights reserved. このトレーニング内容の全体または一部を複製または再配布することは、Amazon Web Services, Inc. の書面による事前の許可がある場合を除き、禁じられています。商業目的のコピー、貸与、または販売を禁止します。